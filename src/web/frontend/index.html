<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical NER Tool - PhoBERT vs CRF</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Nh·∫≠n di·ªán th·ª±c th·ªÉ trong lƒ©nh v·ª±c y t·∫ø</h1>
            <p class="subtitle">So s√°nh PhoBERT (Deep Learning) v√† CRF (Machine Learning)</p>
        </header>

        <div class="model-card" style="margin-bottom: 30px;">
            <div class="model-header">
                 <div class="model-title">üìù Nh·∫≠p vƒÉn b·∫£n</div>
            </div>
            <div class="input-section">
                <label for="input-shared">Nh·∫≠p vƒÉn b·∫£n y t·∫ø t·∫°i ƒë√¢y:</label>
                <textarea id="input-shared" placeholder="V√≠ d·ª•: B·ªánh nh√¢n nh·∫≠p vi·ªán v√¨ ƒëau ng·ª±c d·ªØ d·ªôi v√† kh√≥ th·ªü..." rows="6"></textarea>
            </div>
            <div class="button-group" style="margin-bottom: 0;">
                <button class="clear-btn" onclick="clearAll()" style="flex: 0.5;">üóëÔ∏è X√≥a vƒÉn b·∫£n</button>
            </div>
        </div>

        <div class="models-container">
            <div class="model-card">
                <div class="model-header">
                    <div class="model-title">PhoBERT</div>
                    <div class="model-badge">Deep Learning</div>
                </div>
                <div class="button-group">
                    <button class="analyze-btn" onclick="analyzeText('linear')">üîç Ph√¢n t√≠ch (Linear)</button>
                </div>
                <div class="results-section" id="results-linear">
                    <div class="results-title">K·∫øt qu·∫£ ph√¢n t√≠ch:</div>
                    <div id="output-linear" class="loading">Nh·∫•n "Ph√¢n t√≠ch" ƒë·ªÉ xem k·∫øt qu·∫£...</div>
                </div>
            </div>

            <div class="model-card">
                <div class="model-header">
                    <div class="model-title">CRF</div>
                    <div class="model-badge">Machine Learning</div>
                </div>
                <div class="button-group">
                    <button class="analyze-btn" onclick="analyzeText('crf')">üîç Ph√¢n t√≠ch (CRF)</button>
                </div>
                <div class="results-section" id="results-crf">
                    <div class="results-title">K·∫øt qu·∫£ ph√¢n t√≠ch:</div>
                    <div id="output-crf" class="loading">Nh·∫•n "Ph√¢n t√≠ch" ƒë·ªÉ xem k·∫øt qu·∫£...</div>
                </div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-title">üìã Ch√∫ th√≠ch c√°c lo·∫°i th·ª±c th·ªÉ</div>
            <div class="legend-grid">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e6dc8a; border: 1px solid #fbc02d;"></div>
                    <span>Tri·ªáu ch·ª©ng b·ªánh</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2fce6c; border: 1px solid #34cc40;"></div>
                    <span>T√™n b·ªánh</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2196f3; border: 1px solid #1976d2;"></div>
                    <span>Nguy√™n nh√¢n b·ªánh</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9c27b0; border: 1px solid #7b1fa2;"></div>
                    <span>Bi·ªán ph√°p ch·∫©n ƒëo√°n</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e91e63; border: 1px solid #c2185b;"></div>
                    <span>Bi·ªán ph√°p ƒëi·ªÅu tr·ªã</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API URL kh√¥ng ƒë·ªïi
        const API_URL = 'http://127.0.0.1:8001';

        async function analyzeText(modelType) {
            const input = document.getElementById('input-shared'); 
            const text = input.value.trim();
            const output = document.getElementById(`output-${modelType}`); 

            if (!text) {
                alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p vƒÉn b·∫£n v√†o √¥ 'Nh·∫≠p vƒÉn b·∫£n' b√™n tr√™n.");
                output.innerHTML = '<div class="loading">Vui l√≤ng nh·∫≠p vƒÉn b·∫£n v√†o √¥ b√™n tr√™n.</div>';
                return;
            }

            // X√°c ƒë·ªãnh endpoint ƒë·ªÉ g·ªçi
            let endpoint = '';
            if (modelType === 'linear') {
                endpoint = '/analyze-linear';
            } else if (modelType === 'crf') {
                endpoint = '/analyze-crf'; // <-- G·ªåI ENDPOINT M·ªöI
            } else {
                return; // Kh√¥ng l√†m g√¨ n·∫øu modelType l·∫°
            }

            output.innerHTML = '<div class="loading">‚è≥ ƒêang ph√¢n t√≠ch...</div>';
            
            try {
                const response = await fetch(API_URL + endpoint, { // <-- D√πng endpoint linh ho·∫°t
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text }), 
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `L·ªói t·ª´ server: ${response.statusText}`);
                }

                const results = await response.json(); 
                renderResults(results, output); // H√†m renderResults d√πng chung cho c·∫£ 2

            } catch (error){
                console.error(`L·ªói khi g·ªçi API (${modelType}):`, error);
                output.innerHTML = `<div class="loading">‚ùå L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß AI. (${error.message})</div>`;
            }
        }

        // H√†m renderResults kh√¥ng thay ƒë·ªïi, n√≥ ho·∫°t ƒë·ªông cho c·∫£ 2
        function renderResults(results, outputElement) {
            if (!results || results.length === 0 || results.error) {
                // ... (code gi·ªØ nguy√™n)
                outputElement.innerHTML = '<div class="loading">Kh√¥ng t√¨m th·∫•y th·ª±c th·ªÉ.</div>';
                if(results.error) {
                    outputElement.innerHTML = `<div class="loading">‚ùå L·ªói t·ª´ server: ${results.error}</div>`;
                }
                return;
            }
            let html = '';
            let currentTag = null; 
            for (const [word, tag] of results) {
                // ... (code gi·ªØ nguy√™n)
                const wordWithSpace = word + " "; 
                if (tag === 'O') {
                    if (currentTag) {
                        html += '</span>';
                        currentTag = null;
                    }
                    html += wordWithSpace; 
                } else {
                    // Ki·ªÉm tra tag h·ª£p l·ªá (tr√°nh l·ªói B- ho·∫∑c I- ƒë·ª©ng m·ªôt m√¨nh)
                    if (tag.indexOf('-') === -1) {
                         html += wordWithSpace; // Coi nh∆∞ l√† 'O'
                         continue;
                    }
                    const tagType = tag.split('-')[1]; 
                    const tagPrefix = tag.split('-')[0]; 
                    if (tagPrefix === 'B') {
                        if (currentTag) {
                            html += '</span>';
                        }
                        html += `<span class="entity entity-${tagType}">` + wordWithSpace;
                        currentTag = tagType;
                    } else if (tagPrefix === 'I') {
                        if (currentTag === tagType) {
                            html += wordWithSpace;
                        } else {
                            if (currentTag) {
                                html += '</span>';
                            }
                            html += `<span class="entity entity-${tagType}">` + wordWithSpace;
                            currentTag = tagType;
                        }
                    }
                }
            }
            if (currentTag) {
                html += '</span>';
            }
            outputElement.innerHTML = html.trim(); 
        }

        // H√†m clearAll kh√¥ng thay ƒë·ªïi
        function clearAll() {
            document.getElementById('input-shared').value = '';
            document.getElementById('output-linear').innerHTML = 
                '<div class="loading">Nh·∫•n "Ph√¢n t√≠ch" ƒë·ªÉ xem k·∫øt qu·∫£...</div>';
            document.getElementById('output-crf').innerHTML = 
                '<div class="loading">Nh·∫•n "Ph√¢n t√≠ch" ƒë·ªÉ xem k·∫øt qu·∫£...</div>';
        }
    </script>
</body>
</html>